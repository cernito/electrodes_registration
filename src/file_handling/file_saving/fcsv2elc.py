import re

def parse_fcsv(fcsv_content):
    """Parse FCSV content and return dictionary of coordinates."""
    coordinates = {}

    # Split content into lines and skip header lines
    lines = fcsv_content.strip().split('\n')
    data_lines = [line for line in lines if not line.startswith('#')]

    for line in data_lines:
        # Split line by comma and extract relevant fields
        fields = line.split(',')
        if len(fields) >= 4:
            label = fields[0].strip()
            try:
                x = float(fields[1])
                y = float(fields[2])
                z = float(fields[3])
                coordinates[label.upper()] = (x, y, z)
            except ValueError:
                print(f"Warning: Invalid coordinate values in line: {line}")
                continue

    return coordinates

def format_elc_output(coordinates):
    """Format coordinates into ELC format using tabs."""
    # Header
    output = [
        "NumberPositions= 128",
        "UnitPosition mm",
        "Positions"
    ]

    # Format for coordinate output with tabs
    def format_coordinate(label, coord):
        x, y, z = coord
        return f"{label}\t:\t{x:.3f}\t{y:.3f}\t{z:.3f}"

    # Add all coordinates
    for label, coord in coordinates.items():
        # Convert label to uppercase for ELC format
        elc_label = label.upper()
        output.append(format_coordinate(elc_label, coord))

    # Add Labels section
    output.append("Labels")
    labels_line = "\t".join(coordinates.keys())
    output.append(labels_line)

    return "\n".join(output)

def transform_fcsv_to_elc(fcsv_content):
    """Transform FCSV content to ELC format."""
    # Parse FCSV content
    coordinates = parse_fcsv(fcsv_content)

    # Format as ELC
    elc_content = format_elc_output(coordinates)

    return elc_content

# Example usage:
if __name__ == "__main__":
    # Your FCSV content would go here
    fcsv_content = """# Markups fiducial file version = 5.4
# CoordinateSystem = LPS
# columns = id,x,y,z,ow,ox,oy,oz,vis,sel,lock,label,desc,associatedNodeID
1,30.29334259033203,-72.0566635131836,11.13758373260498,0,0,0,1,1,1,0,F-1,,,2,0
2,-28.991600036621094,-73.48982238769531,9.010903358459473,0,0,0,1,1,1,0,F-2,,,2,0
3,-19.685619354248047,-69.95760345458984,24.999895095825195,0,0,0,1,1,1,0,F-3,,,2,0
4,-2.74861478805542,-65.73357391357422,38.72287368774414,0,0,0,1,1,1,0,F-4,,,2,0
5,17.53803253173828,-70.6717758178711,25.94308853149414,0,0,0,1,1,1,0,F-5,,,2,0
6,-20.21286964416504,-50.86271667480469,55.380859375,0,0,0,1,1,1,0,F-6,,,2,0
7,12.18157958984375,-50.79246139526367,56.90591049194336,0,0,0,1,1,1,0,F-7,,,2,0
8,33.851219177246094,-54.870574951171875,36.691158294677734,0,0,0,1,1,1,0,F-8,,,2,0
9,52.70683288574219,-51.374420166015625,4.392340183258057,0,0,0,1,1,1,0,F-9,,,2,0
10,-41.05259704589844,-53.133792877197266,33.30421447753906,0,0,0,1,1,1,0,F-10,,,2,0
11,-54.48740768432617,-41.829708099365234,24.778535842895508,0,0,0,1,1,1,0,F-11,,,2,0
12,-54.65748596191406,-51.059547424316406,-2.047933340072632,0,0,0,1,1,1,0,F-12,,,2,0
13,-62.370948791503906,-31.688631057739258,18.56331443786621,0,0,0,1,1,1,0,F-13,,,2,0
14,-63.830101013183594,-18.905672073364258,32.87031936645508,0,0,0,1,1,1,0,F-14,,,2,0
15,-47.80080795288086,-19.99982261657715,59.03868865966797,0,0,0,1,1,1,0,F-15,,,2,0
16,-32.589111328125,-35.8560905456543,63.253116607666016,0,0,0,1,1,1,0,F-16,,,2,0
17,-20.695701599121094,-25.34343147277832,75.33565521240234,0,0,0,1,1,1,0,F-17,,,2,0
18,-3.693770408630371,-41.82097625732422,67.58853912353516,0,0,0,1,1,1,0,F-18,,,2,0
19,10.620767593383789,-25.88625144958496,74.19825744628906,0,0,0,1,1,1,0,F-19,,,2,0
20,23.233814239501953,-37.018497467041016,64.84759521484375,0,0,0,1,1,1,0,F-20,,,2,0
21,38.09791564941406,-22.41797637939453,63.25392532348633,0,0,0,1,1,1,0,F-21,,,2,0
22,24.219545364379883,-9.443581581115723,77.96098327636719,0,0,0,1,1,1,0,F-22,,,2,0
23,-5.565279483795166,-10.352337837219238,82.178466796875,0,0,0,1,1,1,0,F-23,,,2,0
24,10.96469783782959,5.739902019500732,85.37157440185547,0,0,0,1,1,1,0,F-24,,,2,0
25,-20.750022888183594,4.837027549743652,84.2060546875,0,0,0,1,1,1,0,F-25,,,2,0
26,-34.81292724609375,-7.595749855041504,74.52827453613281,0,0,0,1,1,1,0,F-26,,,2,0
27,-51.00791931152344,9.969144821166992,64.83726501464844,0,0,0,1,1,1,0,F-27,,,2,0
28,-38.06338119506836,24.7010440826416,78.64685821533203,0,0,0,1,1,1,0,F-28,,,2,0
29,-22.315391540527344,42.842041015625,82.91035461425781,0,0,0,1,1,1,0,F-29,,,2,0
30,11.574274063110352,41.8280143737793,88.19587707519531,0,0,0,1,1,1,0,F-30,,,2,0
31,67.11408233642578,-29.719097137451172,-1.437726378440857,0,0,0,1,1,1,0,F-31,,,2,0
32,27.45772933959961,24.16767120361328,83.09025573730469,0,0,0,1,1,1,0,F-32,,,2,0
33,41.994571685791016,6.284976005554199,72.46216583251953,0,0,0,1,1,1,0,F-33,,,2,0
34,52.12702178955078,-7.7916436195373535,58.41019821166992,0,0,0,1,1,1,0,F-34,,,2,0
35,58.207733154296875,-22.92305564880371,40.38859176635742,0,0,0,1,1,1,0,F-35,,,2,0
36,49.852760314941406,-44.53926086425781,29.62017059326172,0,0,0,1,1,1,0,F-36,,,2,0
37,43.40361022949219,-35.74275207519531,49.883087158203125,0,0,0,1,1,1,0,F-37,,,2,0
38,58.84291076660156,-34.784523010253906,25.628244400024414,0,0,0,1,1,1,0,F-38,,,2,0
39,66.27371215820312,5.994180679321289,44.91502380371094,0,0,0,1,1,1,0,F-39,,,2,0
40,68.72173309326172,-9.185991287231445,27.390424728393555,0,0,0,1,1,1,0,F-40,,,2,0
41,43.71967315673828,39.66551971435547,73.9564437866211,0,0,0,1,1,1,0,F-41,,,2,0
42,58.3929443359375,21.989749908447266,62.291934967041016,0,0,0,1,1,1,0,F-42,,,2,0
43,69.57759094238281,38.725921630859375,46.28215026855469,0,0,0,1,1,1,0,F-43,,,2,0
44,76.2920150756836,-4.442675590515137,-5.973455905914307,0,0,0,1,1,1,0,F-44,,,2,0
45,76.1154556274414,21.106426239013672,28.11484718322754,0,0,0,1,1,1,0,F-45,,,2,0
46,77.90393829345703,6.4661993980407715,9.681990623474121,0,0,0,1,1,1,0,F-46,,,2,0
47,69.23616027832031,-20.314891815185547,11.96262264251709,0,0,0,1,1,1,0,F-47,,,2,0
48,78.94200134277344,38.47323989868164,9.862525939941406,0,0,0,1,1,1,0,F-48,,,2,0
49,78.16438293457031,3.10154390335083,-27.966960906982422,0,0,0,1,1,1,0,F-49,,,2,0
50,75.84618377685547,39.3306770324707,-60.95321273803711,0,0,0,1,1,1,0,F-50,,,2,0
51,74.15733337402344,62.451210021972656,-25.407487869262695,0,0,0,1,1,1,0,F-51,,,2,0
52,79.11508178710938,51.26541519165039,-6.490849018096924,0,0,0,1,1,1,0,F-52,,,2,0
53,66.97987365722656,73.4446029663086,-34.89857482910156,0,0,0,1,1,1,0,F-53,,,2,0
54,69.1020278930664,67.70696258544922,8.882948875427246,0,0,0,1,1,1,0,F-54,,,2,0
55,73.01103210449219,53.150211334228516,28.351987838745117,0,0,0,1,1,1,0,F-55,,,2,0
56,66.79176330566406,76.18473052978516,-5.106347560882568,0,0,0,1,1,1,0,F-56,,,2,0
57,60.5156364440918,85.45053100585938,-15.72797966003418,0,0,0,1,1,1,0,F-57,,,2,0
58,53.759986877441406,54.45811462402344,60.972267150878906,0,0,0,1,1,1,0,F-58,,,2,0
59,62.42802429199219,67.21582794189453,41.708740234375,0,0,0,1,1,1,0,F-59,,,2,0
60,39.52473449707031,69.99784851074219,68.2655029296875,0,0,0,1,1,1,0,F-60,,,2,0
61,25.88092803955078,56.13282775878906,80.76770782470703,0,0,0,1,1,1,0,F-61,,,2,0
62,11.330711364746094,74.20154571533203,74.95767211914062,0,0,0,1,1,1,0,F-62,,,2,0
63,48.509151458740234,81.73950958251953,47.17544174194336,0,0,0,1,1,1,0,F-63,,,2,0
64,-6.118221759796143,56.6854362487793,84.12471771240234,0,0,0,1,1,1,0,F-64,,,2,0
65,-22.484365463256836,40.556766510009766,84.02445983886719,0,0,0,1,1,1,0,F-65,,,2,0
66,-38.153045654296875,57.02396774291992,74.15128326416016,0,0,0,1,1,1,0,F-66,,,2,0
67,-52.941741943359375,40.06264877319336,66.88833618164062,0,0,0,1,1,1,0,F-67,,,2,0
68,-22.037090301513672,75.21358489990234,72.50503540039062,0,0,0,1,1,1,0,F-68,,,2,0
69,-31.018579483032227,86.29784393310547,56.66321563720703,0,0,0,1,1,1,0,F-69,,,2,0
70,-49.236412048339844,71.05422973632812,56.43183898925781,0,0,0,1,1,1,0,F-70,,,2,0
71,-18.828617095947266,97.2061767578125,47.13050842285156,0,0,0,1,1,1,0,F-71,,,2,0
72,14.137897491455078,96.19644927978516,49.70817947387695,0,0,0,1,1,1,0,F-72,,,2,0
73,25.440248489379883,86.08390808105469,60.470035552978516,0,0,0,1,1,1,0,F-73,,,2,0
74,36.559173583984375,98.24748992919922,30.223648071289062,0,0,0,1,1,1,0,F-74,,,2,0
75,48.451942443847656,89.29729461669922,29.717960357666016,0,0,0,1,1,1,0,F-75,,,2,0
76,48.257354736328125,94.24654388427734,12.744064331054688,0,0,0,1,1,1,0,F-76,,,2,0
77,19.019983291625977,110.19593048095703,11.22844409942627,0,0,0,1,1,1,0,F-77,,,2,0
78,-1.8366013765335083,105.3280258178711,32.73613357543945,0,0,0,1,1,1,0,F-78,,,2,0
79,-16.883991241455078,111.4999008178711,7.760431289672852,0,0,0,1,1,1,0,F-79,,,2,0
80,31.517057418823242,106.80020904541016,-5.168123722076416,0,0,0,1,1,1,0,F-80,,,2,0
81,-35.902156829833984,99.93614959716797,22.885961532592773,0,0,0,1,1,1,0,F-81,,,2,0
82,-48.64751434326172,92.79318237304688,20.41904640197754,0,0,0,1,1,1,0,F-82,,,2,0
83,-45.72368621826172,97.69409942626953,3.4102585315704346,0,0,0,1,1,1,0,F-83,,,2,0
84,-25.887725830078125,110.6885757446289,-9.471782684326172,0,0,0,1,1,1,0,F-84,,,2,0
85,-11.165287017822266,112.89599609375,-26.508882522583008,0,0,0,1,1,1,0,F-85,,,2,0
86,19.929677963256836,111.77146911621094,-22.6289005279541,0,0,0,1,1,1,0,F-86,,,2,0
87,51.969879150390625,91.39745330810547,-23.706844329833984,0,0,0,1,1,1,0,F-87,,,2,0
88,50.42714309692383,93.09774780273438,-3.381535291671753,0,0,0,1,1,1,0,F-88,,,2,0
89,35.98366928100586,104.7742919921875,-23.423568725585938,0,0,0,1,1,1,0,F-89,,,2,0
90,6.754611968994141,108.88311767578125,-39.12764358520508,0,0,0,1,1,1,0,F-90,,,2,0
91,-27.712114334106445,106.73468017578125,-27.357072830200195,0,0,0,1,1,1,0,F-91,,,2,0
92,-46.620079040527344,97.8563461303711,-12.967612266540527,0,0,0,1,1,1,0,F-92,,,2,0
93,-43.817378997802734,95.82150268554688,-34.013057708740234,0,0,0,1,1,1,0,F-93,,,2,0
94,-53.19126510620117,89.58949279785156,-29.106422424316406,0,0,0,1,1,1,0,F-94,,,2,0
95,-61.28056716918945,80.916015625,11.429655075073242,0,0,0,1,1,1,0,F-95,,,2,0
96,-69.9140396118164,67.97230529785156,-4.502612113952637,0,0,0,1,1,1,0,F-96,,,2,0
97,-56.415245056152344,79.62061309814453,-48.480316162109375,0,0,0,1,1,1,0,F-97,,,2,0
98,-67.08269500732422,67.28844451904297,-38.9155387878418,0,0,0,1,1,1,0,F-98,,,2,0
99,-64.91416931152344,70.10285949707031,27.539443969726562,0,0,0,1,1,1,0,F-99,,,2,0
100,-60.43206787109375,54.669307708740234,51.454952239990234,0,0,0,1,1,1,0,F-100,,,2,0
101,-72.01847076416016,37.89761734008789,34.50638198852539,0,0,0,1,1,1,0,F-101,,,2,0
102,-74.01702880859375,55.262516021728516,14.008776664733887,0,0,0,1,1,1,0,F-102,,,2,0
103,-73.55810546875,52.27495574951172,-23.18026351928711,0,0,0,1,1,1,0,F-103,,,2,0
104,-77.3057632446289,39.68912887573242,-3.582273006439209,0,0,0,1,1,1,0,F-104,,,2,0
105,-62.61634063720703,45.05120086669922,-72.0292739868164,0,0,0,1,1,1,0,F-105,,,2,0
106,-77.61507415771484,11.483330726623535,-1.689255952835083,0,0,0,1,1,1,0,F-106,,,2,0
107,-78.07781219482422,24.146907806396484,17.270471572875977,0,0,0,1,1,1,0,F-107,,,2,0
108,-70.83441925048828,8.262358665466309,33.943077087402344,0,0,0,1,1,1,0,F-108,,,2,0
109,-74.1998291015625,-1.2501521110534668,-17.993547439575195,0,0,0,1,1,1,0,F-109,,,2,0
110,-74.34424591064453,6.123779296875,-37.38507080078125,0,0,0,1,1,1,0,F-110,,,2,0
111,-69.70501708984375,-19.019411087036133,2.402453899383545,0,0,0,1,1,1,0,F-111,,,2,0
112,-73.24192810058594,-5.904890060424805,18.53347396850586,0,0,0,1,1,1,0,F-112,,,2,0
113,-59.149070739746094,-6.034873962402344,53.54012680053711,0,0,0,1,1,1,0,F-113,,,2,0
114,-66.08089447021484,26.328994750976562,53.17307662963867,0,0,0,1,1,1,0,F-114,,,2,0
115,-50.51877212524414,-35.30583572387695,45.80426025390625,0,0,0,1,1,1,0,F-115,,,2,0
116,-78.12993621826172,24.260936737060547,-20.07889747619629,0,0,0,1,1,1,0,F-116,,,2,0
117,-70.14118957519531,-10.045722007751465,-53.53889083862305,0,0,0,1,1,1,0,F-117,,,2,0
118,-66.40547180175781,-28.62228775024414,-11.804061889648438,0,0,0,1,1,1,0,F-118,,,2,0
119,74.73851776123047,-11.136630058288574,-41.60136032104492,0,0,0,1,1,1,0,F-119,,,2,0
120,82.26734924316406,22.13422393798828,-9.114047050476074,0,0,0,1,1,1,0,F-120,,,2,0
121,60.8504753112793,79.6606216430664,21.598480224609375,0,0,0,1,1,1,0,F-121,,,2,0
122,-3.383225679397583,88.64020538330078,63.33778762817383,0,0,0,1,1,1,0,F-122,,,2,0
123,2.848721742630005,114.99810028076172,-4.733607292175293,0,0,0,1,1,1,0,F-123,,,2,0
124,-51.198795318603516,83.83511352539062,38.43574905395508,0,0,0,1,1,1,0,F-124,,,2,0
125,-7.103256702423096,23.210601806640625,88.8133773803711,0,0,0,1,1,1,0,F-125,,,2,0
126,37.39875793457031,101.73960876464844,-40.25212860107422,0,0,0,1,1,1,0,F-126,,,2,0
127,-22.01287841796875,103.7330093383789,-47.64876937866211,0,0,0,1,1,1,0,F-127,,,2,0
128,7.119390487670898,-78.61250305175781,9.293635368347168,0,0,0,1,1,1,0,F-128,,,2,0
"""

    # Transform to ELC
    elc_output = transform_fcsv_to_elc(fcsv_content)

    # Write to file
    with open('output.elc', 'w') as f:
        f.write(elc_output)

    print("ELC file has been generated successfully.")
